<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Spring Cloud中国社区文档,Spring Cloud中国社区官网,Spring Cloud中国社区,致力于为Spring Boot或Spring Cloud技术人员提供分享和交流的平台! www.springcloud.cn,springcloud.cn,spring coud中文">
        <meta name="author" content="许进">
        <link rel="canonical" href="http://docs.springcloud.cn/user-guide/bus/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Spring Cloud Bus - Spring Cloud中国社区</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
         
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Spring Cloud中国社区</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">首页</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Spring Cloud中文翻译文档 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../eureka/">Spring Cloud Eureka</a>
</li>

                    
                        
<li >
    <a href="../feign/">声明式REST客户端Feign</a>
</li>

                    
                        
<li class="active">
    <a href="./">Spring Cloud Bus</a>
</li>

                    
                        
<li >
    <a href="../config/">Spring Cloud Config</a>
</li>

                    
                        
<li >
    <a href="../sleuth/">Spring Cloud sleuth</a>
</li>

                    
                        
<li >
    <a href="../stream/">Spring Cloud stream</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../feign/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../config/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                <li>
                    <a href="https://github.com/springcloud">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
    
        <li class="main active"><a href="#spring-cloud-bus">Spring Cloud Bus</a></li>
        
            <li><a href="#quick-start">Quick Start</a></li>
        
            <li><a href="#addressing-an-instance">Addressing an Instance</a></li>
        
            <li><a href="#addressing-all-instances-of-a-service">Addressing all instances of a service</a></li>
        
            <li><a href="#application-context-id-must-be-unique">Application Context ID must be unique</a></li>
        
            <li><a href="#customizing-the-message-broker">Customizing the Message Broker</a></li>
        
            <li><a href="#tracing-bus-events">Tracing Bus Events</a></li>
        
            <li><a href="#broadcasting-your-own-events">Broadcasting Your Own Events</a></li>
        
    
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="spring-cloud-bus">Spring Cloud Bus<a class="headerlink" href="#spring-cloud-bus" title="Permanent link">#</a></h1>
<p>Spring Cloud Bus 通过一个轻量级消息代理连接分布式系统的节点。这可以用于广播状态更改（如配置更改）或其他管理指令。当前唯一的实现方式是通过一个AMQP代理作为消息传输，但相同的基本特征（传输上的一些依赖）是其他传输的路线图</p>
<h2 id="quick-start">Quick Start<a class="headerlink" href="#quick-start" title="Permanent link">#</a></h2>
<p>如果Spring Cloud Bus在类路径里它将通过Spring Boot autconfiguration启动。所有你需要做的就是使<code>spring-cloud-starter-bus-amqp</code>或<code>spring-cloud-starter-bus-kafka</code>添加到你的依赖管理中，Spring Cloud将完成剩下的事。确定broker (RabbitMQ or Kafka) 可用：如果在本地运行你不需要做任何事，但如果在远程运行需要配置broker信息，如Rabbit</p>
<p>application.yml</p>
<pre><code>spring:
  rabbitmq:
    host: mybroker.com
    port: 5672
    username: user
    password: secret
</code></pre>
<p>bus目前支持向所有的监听节点发送消息，或向所有特定服务节点（注册到Eureka中的）发送消息。更多的选择标准可能在未来增加 (ie. only service X nodes in data center Y, etc…​)。在<code>/bus/*</code>命名空间下有一些http的endpoints，目前有两个实现，第一个<code>/bus/env</code>，发送键/值对来更新每个节点Spring Environment，第二个<code>/bus/refresh</code>，重载每个应用程序的配置，就好像他们都被发现通过 <code>/refresh</code> endpoint。</p>
<p>NOTE </p>
<blockquote>
<p>Bus的starters含盖Rabbit和Kafka，因为这两个比较常见，另一方面Spring Cloud Stream十分灵活，binder将结合spring-cloud-bus进行工作。</p>
</blockquote>
<h2 id="addressing-an-instance">Addressing an Instance<a class="headerlink" href="#addressing-an-instance" title="Permanent link">#</a></h2>
<p>HTTP endpoints 接受<code>"destination"</code>参数,如：<code>"/bus/refresh?destination=customers:9000"</code>，<code>"destination"</code>参数是<code>ApplicationContext</code>的ID，如果一个Bus实例拥有一个ID，然后它将处理消息，并且所有其他实例将忽略它。Spring Boot在<code>ContextIdApplicationContextInitializer</code>设置这个ID，ID的组成默认是由<code>spring.application.name</code>， active profiles ， <code>server.port</code></p>
<h2 id="addressing-all-instances-of-a-service">Addressing all instances of a service<a class="headerlink" href="#addressing-all-instances-of-a-service" title="Permanent link">#</a></h2>
<p>destination参数采用Spring PathMatcher（分隔符<code>：</code>）确认某个实例是否将处理消息,使用上面的例子"/bus/refresh?destination=customers:**" 将对象的所有实例的“customers”服务的配置和端口设置为ApplicationContext的ID</p>
<h2 id="application-context-id-must-be-unique">Application Context ID must be unique<a class="headerlink" href="#application-context-id-must-be-unique" title="Permanent link">#</a></h2>
<p>bus 试图消除处理一个事件两次，一次从原来的applicationevent消除，一次从队列消除。要做到这一点，它检查发送应中的用程序上下文ID和当前应用程序上下文ID，如果多个服务实例具有相同的应用程序上下文ID，事件将不被处理。在本地机器上运行，每个服务将在一个不同的端口，这将是应用程序上下文ID的一部分。云计算提供了一个索引来区分。Cloud Foundry提供了一个索引来区分。确保应用程序上下文ID是唯一的，对每一个服务实例设置<code>spring.application.index</code>唯一。例如，在框架配置application.properties（或bootstrap.properties如果使用configserver）中设置<code>spring.application.index=${INSTANCE_INDEX}</code></p>
<h2 id="customizing-the-message-broker">Customizing the Message Broker<a class="headerlink" href="#customizing-the-message-broker" title="Permanent link">#</a></h2>
<p>Spring Cloud Bus 通过 Spring Cloud Stream 广播消息从而获得信息的流动，你只需要在类路径中选择你绑定的实现。bus有方便的starters，AMQP (RabbitMQ) 和 Kafka (spring-cloud-starter-bus-[amqp,kafka])。一般来说，Spring Cloud Stream依靠Spring Boot autoconfiguration规则配置中间件，所以例如AMQP代理地址是可以通过<code>spring.rabbitmq.*</code>属性配置改变的。Spring Cloud Bus有少数本地配置<code>spring.cloud.bus.*</code> (例如 <code>spring.cloud.bus.destination</code>是使用的体中间件的主题的名称)。通常情况下，默认值就足够了。</p>
<h2 id="tracing-bus-events">Tracing Bus Events<a class="headerlink" href="#tracing-bus-events" title="Permanent link">#</a></h2>
<p>Bus events（RemoteApplicationEvent的子类）可以通过设置<code>spring.cloud.bus.trace.enabled=true</code>追踪，如果你这样做的话，Spring Boot TraceRepository（如果存在）将显示每个事件发送和每个服务实例所有的acks。例如(/trace endpoint):</p>
<pre><code>{
  "timestamp": "2015-11-26T10:24:44.411+0000",
  "info": {
    "signal": "spring.cloud.bus.ack",
    "type": "RefreshRemoteApplicationEvent",
    "id": "c4d374b7-58ea-4928-a312-31984def293b",
    "origin": "stores:8081",
    "destination": "*:**"
  }
  },
  {
  "timestamp": "2015-11-26T10:24:41.864+0000",
  "info": {
    "signal": "spring.cloud.bus.sent",
    "type": "RefreshRemoteApplicationEvent",
    "id": "c4d374b7-58ea-4928-a312-31984def293b",
    "origin": "customers:9000",
    "destination": "*:**"
  }
  },
  {
  "timestamp": "2015-11-26T10:24:41.862+0000",
  "info": {
    "signal": "spring.cloud.bus.ack",
    "type": "RefreshRemoteApplicationEvent",
    "id": "c4d374b7-58ea-4928-a312-31984def293b",
    "origin": "customers:9000",
    "destination": "*:**"
  }
}
</code></pre>
<p>这个trace显示了来自<code>customers:9000</code>的<code>RefreshRemoteApplicationEvent</code>，广播到所有的服务，通过<code>customers:9000</code>和<code>stores:8081</code>收到（acked）</p>
<p>处理自己的ACK信号你可以为AckRemoteApplicationEvent添加@EventListener，在添加SentApplicationEvent类型，或者你可以进入TraceRepository，从那里开采数据。</p>
<p>NOTE</p>
<blockquote>
<p>所有Bus应用都可以追踪acks，在做复杂查询的数据中央服务中这么做是有用的，或将其转发到一个专门的跟踪服务。</p>
</blockquote>
<h2 id="broadcasting-your-own-events">Broadcasting Your Own Events<a class="headerlink" href="#broadcasting-your-own-events" title="Permanent link">#</a></h2>
<p>Bus可以支持任何RemoteApplicationEvent的事件类型，但默认传输JSON和反序列化器需要提前知道哪些类型将被使用。定义一个新类型需要在org.springframework.cloud.bus.event的子目录下，可以使用@JsonTypeName注解在你的定制类上或依赖于默认的策略，使用类的简单的名字。请注意，生产者和消费者都需要访问类定义。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Copyright &copy; 2016-2020 <a href="http://blog.xujin.org">许进博客</a>,<a href="http://blog.didispace.com/">程序猿DD</a>, <a href="http://springcloud.cn">Spring Cloud中国社区</a></center>
            
            <!--<center>访问人数 <a href="#">n</a>.</center>-->
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>