<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Spring Cloud中国社区文档,Spring Cloud中国社区官网,Spring Cloud中国社区,致力于为Spring Boot或Spring Cloud技术人员提供分享和交流的平台! www.springcloud.cn,springcloud.cn,spring coud中文">
        <meta name="author" content="许进">
        <link rel="canonical" href="http://docs.springcloud.cn/user-guide/zuul/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Spring Cloud zuul - Spring Cloud中国社区</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
         
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Spring Cloud中国社区</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">首页</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">project <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../project/QuickStart/">Quick Start</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudConfig/">Spring Cloud Config</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudNetflix/">Spring Cloud Netflix</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudBus/">Spring Cloud Bus</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudforCloudFoundry/">Spring Cloud for Cloud Foundry</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudforCloudFoundry/">Spring Cloud Cloud Foundry Service Broker</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudCloudFoundryServiceBroker/">Spring Cloud Cloud Foundry Service Broker</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudConsul/">Spring Cloud Consul</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudSecurity/">Spring Cloud Security</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudSleuth/">Spring Cloud Sleuth</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudDataFlow/">Spring Cloud Data Flow</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudStream/">Spring Cloud Stream</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudStreamModules/">Spring Cloud Stream Modules</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudTask/">Spring Cloud Task</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudZookeeper/">Spring Cloud Zookeeper</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudforAmazonWebServices/">Spring Cloud for Amazon Web Services</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudConnectors/">Spring Cloud Connectors</a>
</li>

                    
                        
<li >
    <a href="../../project/SpringCloudCLI/">Spring Cloud CLI</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Spring Cloud翻译文档 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../eureka/">Spring Cloud Eureka</a>
</li>

                    
                        
<li >
    <a href="../feign/">声明式REST客户端Feign</a>
</li>

                    
                        
<li >
    <a href="../bus/">Spring Cloud Bus</a>
</li>

                    
                        
<li >
    <a href="../config/">Spring Cloud Config</a>
</li>

                    
                        
<li >
    <a href="../sleuth/">Spring Cloud sleuth</a>
</li>

                    
                        
<li >
    <a href="../stream/">Spring Cloud stream</a>
</li>

                    
                        
<li class="active">
    <a href="./">Spring Cloud zuul</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../source/">源码分析</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../stream/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../source/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                <li>
                    <a href="https://github.com/springcloud">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
    
        <li class="main active"><a href="#zuul">Zuul：路由器和过滤器</a></li>
        
            <li><a href="#zuul_1">如何引入Zuul</a></li>
        
            <li><a href="#zuul_2">内置Zuul 反向代理</a></li>
        
    
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="zuul">Zuul：路由器和过滤器<a class="headerlink" href="#zuul" title="Permanent link">#</a></h1>
<p>路由是微服务体系不可或缺的一部分， 例如  /  可以映射到Web 应用， /api/users 可以映射的用户服务 ， api/shop 可以映射到商店服务。 Zuul是一个基于JVM的路由器，同时也是一个服务端负载均衡。
它由Netflix公司开源。</p>
<p>Netflix使用Zuul做如下事情：</p>
<ul>
<li>认证鉴权。</li>
<li>审查</li>
<li>压力测试</li>
<li>金丝雀测试</li>
<li>动态路由</li>
<li>服务迁移</li>
<li>负载剪裁</li>
<li>安全</li>
<li>静态应答处理</li>
</ul>
<p>Zuul允许使用任何支持JVM的语言来建立规则和过滤器，内置了对Java和Groovy的支持。</p>
<h2 id="zuul_1">如何引入Zuul<a class="headerlink" href="#zuul_1" title="Permanent link">#</a></h2>
<p>为了在自己的project中引入zuul，仅仅需要使用spring-cloud-starter-zuul就OK啦。详细的内容参照 Spring Cloud Project page 。</p>
<h2 id="zuul_2">内置Zuul 反向代理<a class="headerlink" href="#zuul_2" title="Permanent link">#</a></h2>
<p>当一个UI应用想要通过代理调用后端服务时，Spring Cloud通过一个内置的Zuul代理，从而减轻一些通用案例的开发。 这个特性对于前端用户交互通过代理访问后端服务是有用的，避免了为所有后端服务单独建立CORS和认证相关管理等事情。在Spring Boot的main类上面添加@EnableZuulProxy注解，它就可以转发本地的调用到适用的服务上面。</p>
<p>按照惯例， 一个服务ID为"users"的服务也将收到来自于/users的请求。代理使用Ribbon（一种客户端负载均衡机制）定位一个服务实例，所有迭代请求在hystrix command（服务异常断路机制）被执行，以致于一旦失败，Hystrix metrics(服务异常断路的监控机制)将能够呈现出来。 一旦断路器被打开， 代理将不再尝试与这个服务联系。</p>
<p>为了跳过一些自动增加的服务，可以设置zuul.ignored-services的值，使其符合想要忽略的服务列表的ID模式。如果一个服务匹配这种忽略的模式，但是被显示的配置到了Routes map里的话，它又不能被忽略。例如：</p>
<pre><code>application.yml
zuul:
  ignoredServices: '*'
  routes:
    users: /myusers/**
</code></pre>
<p>在这个例子里，除了"users"，所有的服务都会被忽略。
为了扩充或者改变代理路由， 你可以增加如下显示的配置：</p>
<pre><code>application.yml
zuul:
  routes:
    users: /myusers/**
</code></pre>
<p>这意味着来自于<code>"/myusers"</code>的http请求将被转发到<code>"users"</code>服务上（例如<code>"/myusers/101"</code>被转发到<code>"/101"</code>）。</p>
<p>为了得到更细粒度的控制，你可以指定具体的路由到服务的标识上：</p>
<pre><code> zuul:
   routes:
   users:
     path: /myusers/**
     serviceId: users_service
</code></pre>
<p>这意味着来自于<code>"/myusers"</code>的http请求被转发到<code>"users_service"</code>这个服务上。
路由必须有一个符合Ant模式的"path"，那么<code>"/myusers/*"</code> 就仅仅匹配第一级，而<code>"/myusers/**"</code> 能够层次化匹配。</p>
<p>后端服务的定位可以按照服务ID或者url来识别。 例如：</p>
<pre><code>application.yml
zuul:
  routes:
  users:
    path: /myusers/**
    url: http://example.com/users_service
</code></pre>
<p>这些简单的url路由是不支持HystrixCommand 和Ribbon负载均衡的。为了实现这一点，需要指定service路由，并且为这个Service配置Ribbon客户端(当前需要在Ribbon失效Eureka的支持）。 例如：</p>
<pre><code>application.yml
zuul:
  routes:
    users:
      path: /myusers/**
      serviceId: users
ribbon:
  eureka:
    enabled: false
users:
  ribbon:
    listOfServers: example.com,google.com
</code></pre>
<p>你可以使用正则匹配来建立ServiceId和路由之间的默契。使用正则表达式命名组来从服务ID中提取变量，注入他们到一个路由模式里。</p>
<pre><code>ApplicationConfiguration.java
@Bean
public PatternServiceRouteMapper serviceRouteMapper() {
    return new PatternServiceRouteMapper(
        "(?&lt;name&gt;^.+)-(?&lt;version&gt;v.+$)",
        "${version}/${name}");
}
</code></pre>
<p>这意味着，一个服务ID为"myusers-v1"将被映射到路由 <code>"/v1/myusers/**"</code>上。任何正则表达式都会被接受，但是所有的名称组必须同时出现在servicePattern和routePattern上。如果servicePattern不匹配Service Id，将使用默认行为。在上面的例子中， 服务ID是"myusers"的服务会被映射到路由：<code>"/myusers/**"</code>（不检测版本）。 这个特性默认是不可用的，并且仅仅适用于已经被发现（应该是已经注册）的服务。</p>
<p>为了给所有的映射增加前缀， 可以设置zuul.prefix，例如/api。默认情况下，在请求被转发前，这个代理前缀会被从请求中去除掉。你也可以按照独立的路由来控制这个功能的切换，例如：</p>
<pre><code>application.yml
 zuul:
  routes:
    users:
      path: /myusers/**
      stripPrefix: false
</code></pre>
<p>这个例子中，请求<code>"/myusers/101"</code>将被转发到<code>"users"</code>服务的<code>"/myusers/101"</code>上。</p>
<p>Zuul.routes条目实际上是绑定到一个类型为ZuulProperties的对象上。如果查找这个对象的属性集，你会返现有一个"retryable"的标志位。将这个标志位设置为true，Ribbon的客户端将自动重试失败的请求。（如果需要，可以使用Ribbon客户端配置更改这个操作的参数）。</p>
<p>默认情况下，X-Forwarded-Host header会被增加到转发的请求里。 如果不想要这个功能，需要设置 <code>zuul.addProxyHeaders = false</code>。 </p>
<p>一个带有@EnableZuulProxy的应用能够作为独立服务器。如果设置一个默认的路由("/")，例如examplezuul.route.home: / 将路由所有的请求到"home" service。</p>
<p>如果需要更细粒度的控制一些路由模式的忽略， 可以指定一个特殊的忽略模式。 这些模式在路由定位过程的开始被计算。这也意味着前缀应该被包含在模式里来保证匹配。忽略模式跨越所有服务和取代所有其他路由规范。</p>
<pre><code>application.yml
zuul:
  ignoredPatterns: /**/admin/**
  routes:
    users: /myusers/**
</code></pre>
<p>这意味着所有的类似<code>"/myusers/101"</code>的请求将被转发到 <code>"users"</code>服务的<code>"/101"</code>上。但包含<code>"/admin/"</code>将不被解析。</p>
<p>注意： 如果你需要你的路由有顺序，需要使用YAML文件，properties file将流失预订的顺序。</p>
<pre><code>application.yml
zuul:
  routes:
    users:
      path: /myusers/**
    legacy:
      path: /**
</code></pre>
<p>如果使用 properties file， legacy路径可能会跑到users路径前面，使得users路径不可达。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Copyright &copy; 2016-2020 <a href="http://blog.xujin.org">许进博客</a>,<a href="http://springcloud.cn">Spring Cloud中国社区</a></center>
            
            <!--<center>访问人数 <a href="#">n</a>.</center>-->
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>